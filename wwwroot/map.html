<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Icon made by Freepik from www.flaticon.com -->
    <link rel="icon" href="img/favicon.ico">

    <title>Rotobox</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/theme.css" rel="stylesheet">

    <link rel="stylesheet" href="css/leaflet.css" />
    <style>
        .ctl {
            padding: 2px 10px 2px 10px;
            background: white;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            text-align: right;
        }
    </style>

  </head>

  <body role="document">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><img src="img/helicopter-sm.png"/></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/">Rotobox</a></li>
            <li class="active"><a href="#about">Map</a></li>
            <li><a href="#about">Hardware</a></li>
            <li><a href="#contact">Config</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Status<span class="caret"></span></a>
              <ul class="dropdown-menu">
                <li><a href="#">GPS</a></li>
                <li><a href="#">SDR</a></li>
                <li><a href="#">Inertial</a></li>
                <li><a href="#">CO2</a></li>
                <li><a href="#">Power</a></li>
              </ul>
            </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container-fluid" role="main">
      <div class="row map-row">
        <div class="col-xs-8 map-content" id="map"></div>
        <div class="col-xs-4 map-sidebar">
          <div class="sidebar-top">
            <input class="map-search" type="text" placeholder="Search..." />
            <hr class="sidebar-hr"/>
          </div>
          <div class="scrollable">
            <p id="airport-name" class="lead text-center airport-name"></span>
            <p id="airport-identifiers" class="text-center airport-identifiers"></p>
            <h5 class="airport-tags text-center"></h5>
            <ul class="list-group" id="airport-runways"></ul>
            <dl class="dl-horizontal">
              <dt>CTAF</dt>
              <dd class="ctaf-frequency"></dd>
              <dt>Field Elevation</dt>
              <dd class="field-elevation"></dd>
            </dl>
            <dl>
              <dt>Remarks</dt>
              <dd id="airport-remarks"></dd>
            </dl>
          </div>
        </div>
      </div>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript   
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="js/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/jsrender.min.js"></script>

    <script src="js/leaflet.js"></script>
    <script type="text/javascript" src="js/rotobox_api.js"></script>
    <script>
      var markerArray = new Array();

      L.Icon.Default.imagePath = 'img';
      /* **** Leaflet **** */

      // Overlay layers (TMS)
      var lyr = L.tileLayer('./charts/{z}/{x}/{y}.png', {tms: true, attribution: ""});

      // Map
      var map = L.map('map', {
          center: [38.248181295, -121.789805051],
          zoom: 5,
          minZoom: 1,
          maxZoom: 11,
          layers: [lyr]
      });

      var ownshipIcon = L.icon({
          iconUrl: 'img/helicopter-top.png',
          iconSize: [48, 48],
          iconAnchor: [24, 24],
      });

      // Rotobox
      rotobox_api(API_URI_LOCATION, {}, function(data) {
          var marker = L.marker([data.latitude, data.longitude], {icon: ownshipIcon}).addTo(map);
          map.setView([data.latitude, data.longitude], 10);
      });

      function show_airport_detail(airport_id){
          rotobox_api(API_AIRPORT_ID, {"id": airport_id}, function(data){
              $("#airport-name").text(data[0].name);
              if(data[0].icao_name == "(null)") {
                $("#airport-identifiers").text(data[0].designator);
              } else {
                $("#airport-identifiers").text(data[0].icao_name + " (" + data[0].designator + ")");
              }
              $("dd.field-elevation").text(data[0].field_elevation + "'");
              $("#airport-remarks").text(data[0].remarks);

              $("h5.airport-tags").empty();
              // TODO: Fix bool values having to be strings
              if(data[0].traffic_control_tower_on_airport == "1") {
                $("h5.airport-tags").append("<span class='label label-primary'>Towered</span>\n");
              } else {
                $("h5.airport-tags").append("<span class='label label-default'>Nontowered</span>\n");
              }

              if(data[0].segmented_circle_marker_on_airport == "1") {
                $("h5.airport-tags").append("<span class='label label-info'>Segmented Circle</span>\n");
              }

              if(data[0].wind_direction_indicator == "1") {
                $("h5.airport-tags").append("<span class='label label-info'>Windsock</span>\n");
              }

              if(data[0].private_use == "1") {
                $("h5.airport-tags").append("<span class='label label-danger'>Private</span>\n");
              }

          });

          $("ul#airport-runways").empty();
          rotobox_api(API_AIRPORT_RUNWAYS, {"id": airport_id}, function(data){
            for (var i = 0; i < data.length; i++) {
              var item = "<li class='list-group-item'>" + data[i].designator
              if((data[i].length != "(null)") && (data[i].width != "(null)")){
                item += "<span class='badge'>" + Math.round(data[i].width) + "' x " + Math.round(data[i].length) + "'</span>\n";
              }
              if(data[i].right_traffic_pattern != "1"){
                item += "<span class='badge rp-badge'>RP</span>\n";
              }
              item += "</li>\n";

              $("ul#airport-runways").append(item);
            }
          });

          rotobox_api(API_AIRPORT_RADIO, {"id": airport_id}, function(data){
            $("dd.ctaf-frequency").text(data[0].tx_frequency);
          });

          $("div.scrollable").scrollTop(0);
      }

      function update_airport_markers(data){
          // Clear out the old markers
          for (var i = 0; i < markerArray.length; i++) {
              map.removeLayer(markerArray[i]);
          }
          markerArray.length = 0;

          // Setup our marker for the airports
          // Size dynamically based on zoom
          var dynamicSize = (map.getZoom() - 8) * 15;
          var airportIcon = L.divIcon({
              className: 'airport-icon',
              iconAnchor: [dynamicSize / 2, dynamicSize / 2],
              iconSize: [dynamicSize, dynamicSize]
          });

          // Add the markers in this viewport
          for (var i = 0; i < data.length; i++) {
              var marker = L.marker([data[i].latitude, data[i].longitude],
                  {
                      icon: airportIcon,
                      title: data[i].name,
                      airport_id: data[i].id
                  });
              marker.on("click", function(){
                  show_airport_detail(this.options.airport_id);
              })
              markerArray.push(marker);
              map.addLayer(markerArray[i]);
          }
      }

      map.on('moveend', function(){
          ROUND_DECIMAL_PLACES = 1000;
          if(map.getZoom() >= 9) {
              bounds = map.getBounds();
              zoom = map.getZoom();

              lonMin = Math.round(bounds.getWest() * ROUND_DECIMAL_PLACES)/ROUND_DECIMAL_PLACES;
              lonMax = Math.round(bounds.getEast() * ROUND_DECIMAL_PLACES)/ROUND_DECIMAL_PLACES;
              latMin = Math.round(bounds.getSouth() * ROUND_DECIMAL_PLACES)/ROUND_DECIMAL_PLACES;
              latMax = Math.round(bounds.getNorth() * ROUND_DECIMAL_PLACES)/ROUND_DECIMAL_PLACES;

              rotobox_api(API_AIRPORT_WINDOW,
                  {
                      "latMin": latMin,
                      "latMax": latMax,
                      "lonMin": lonMin,
                      "lonMax": lonMax
                  },
                  update_airport_markers);
          }
      });

      $("input.map-search").keyup(function(e){
        if(e.keyCode == 13) {
          searchQuery = $(this).val();

          // Clear the text. TODO: Maybe be smarter about when we do this?
          $(this).val("");

          rotobox_api(API_AIRPORT_SEARCH, {"name": searchQuery}, function(results){
            if(results.length == 0){
              console.log("No results found for '" + searchQuery + "'");
            } else if(results.length == 1) {
              map.setView([results[0].latitude, results[0].longitude], 10);
              // TODO: Remove this dedup of API call
              show_airport_detail(results[0].id);
            } else {
              console.log("Found " + results.length + " for '" + searchQuery + "'");
            }
          });
        }
      });
    </script>
  </body>
</html>
